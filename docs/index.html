<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock Analysis Dashboard (Paper Trading)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .meta { color:#555; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: top; }
    th { text-align: left; position: sticky; top: 0; background: #fff; z-index: 1; }
    th.nowrap, td.nowrap { white-space: nowrap; }

    /* Pills */
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid #ddd; font-weight: 600; }
    .pill.buy  { background: #eaf7ee; border-color:#bfe6c7; color:#156b2a; }
    .pill.sell { background: #fdecec; border-color:#f3b6b6; color:#8a1f1f; }
    .pill.hold { background: #f3f4f6; border-color:#e1e3e8; color:#3b3f46; }

    /* Confidence badges */
    .conf { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid #ddd; font-weight: 600; }
    .conf.high { background:#eaf7ee; border-color:#bfe6c7; color:#156b2a; }
    .conf.med  { background:#fff7e6; border-color:#f1d39b; color:#7a4b00; }
    .conf.low  { background:#fdecec; border-color:#f3b6b6; color:#8a1f1f; }

    .small { font-size: 12px; color:#666; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 10px; }
    select, input { padding: 6px 8px; font-size: 14px; }
    .news { margin-top: 4px; }
    .news a { text-decoration:none; }
    .news a:hover { text-decoration:underline; }

    /* Row accents by action */
    tr.row-buy  td:first-child { border-left: 4px solid #2e9b4e; padding-left: 10px; }
    tr.row-sell td:first-child { border-left: 4px solid #d23b3b; padding-left: 10px; }
    tr.row-hold td:first-child { border-left: 4px solid #9aa3af; padding-left: 10px; }

    /* Big mover highlight (top 5 by expected 1W move) */
    tr.big-mover { background: #fff8e1; }
    .star { display:inline-block; font-size: 14px; margin-right: 6px; }

    /* Winners/Losers pinned highlight */
    tr.pin-winner { background: #f0fff4; }
    tr.pin-loser  { background: #fff5f5; }

    /* Section separators */
    tr.section td {
      background:#fafafa;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
      font-weight: 700;
      color:#444;
      padding-top:10px; padding-bottom:10px;
    }

    /* Up/Down colouring */
    .pos { color:#156b2a; font-weight:600; }
    .neg { color:#8a1f1f; font-weight:600; }

    /* Legend */
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin: 8px 0 14px; }
    .legend .item { display:flex; align-items:center; gap:6px; color:#444; font-size:12px; }
    .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }
    .sw-buy { background:#2e9b4e; }
    .sw-sell { background:#d23b3b; }
    .sw-hold { background:#9aa3af; }
    .sw-move { background:#ffd54f; border:1px solid #e7c23b; }

    .hint { margin-top: 6px; font-size: 12px; color:#666; }
  </style>
</head>
<body>
  <h1>Stock Analysis Dashboard (Paper Trading)</h1>
  <div class="meta" id="meta">Loading…</div>
  <div class="hint">
    “Pred Close (1D)” is a conservative estimate using your 1-day range + action direction. It is not guaranteed.
  </div>

  <div class="filters">
    <label>Region
      <select id="region">
        <option value="">All</option>
        <option value="asx">ASX</option>
        <option value="us">US</option>
      </select>
    </label>
    <label>Category
      <select id="category"><option value="">All</option></select>
    </label>
    <label>Action
      <select id="action">
        <option value="">All</option>
        <option value="BUY">BUY</option>
        <option value="HOLD">HOLD</option>
        <option value="SELL">SELL</option>
      </select>
    </label>
    <label>Search
      <input id="q" placeholder="ticker…" />
    </label>
  </div>

  <div class="legend">
    <div class="item"><span class="swatch sw-buy"></span> BUY</div>
    <div class="item"><span class="swatch sw-sell"></span> SELL</div>
    <div class="item"><span class="swatch sw-hold"></span> HOLD</div>
    <div class="item"><span class="swatch sw-move"></span> ⭐ Top 5 biggest expected 1W movers</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ticker</th>
        <th class="nowrap">Region</th>
        <th>Category</th>
        <th class="nowrap">Action</th>
        <th class="nowrap">Confidence</th>
        <th class="nowrap">Prev Close</th>
        <th class="nowrap">Today Close</th>
        <th class="nowrap">Change</th>
        <th class="nowrap">Change %</th>
        <th class="nowrap">Pred Close (1D)</th>
        <th>Ranges (approx)</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <p class="small">Data source: Stooq/Yahoo (prices) + Google News RSS (headlines). Paper-trading research only.</p>

<script>
async function load() {
  const res = await fetch('./data/snapshot.json', {cache:'no-store'});
  const snap = await res.json();
  document.getElementById('meta').textContent = `As of (UTC): ${snap.asof_utc} • Rows: ${snap.rows.length}`;
  window.SNAP = snap;
  initFilters(snap.rows);
  render();
}

function initFilters(rows){
  const cats = Array.from(new Set(rows.map(r=>r.category).filter(Boolean))).sort();
  const sel = document.getElementById('category');
  cats.forEach(c=>{
    const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
  });
  ['region','category','action','q'].forEach(id=>{
    document.getElementById(id).addEventListener('input', render);
    document.getElementById(id).addEventListener('change', render);
  });
}

function fmtPctRange(r){
  if(!r || r.low==null || r.high==null) return '—';
  const lo = (r.low*100).toFixed(1);
  const hi = (r.high*100).toFixed(1);
  return `${lo}% to ${hi}%`;
}

function moveMag(range){
  if(!range || range.low==null || range.high==null) return null;
  return Math.max(Math.abs(range.low), Math.abs(range.high));
}

function confClass(c){
  if(typeof c !== 'number') return 'conf low';
  if(c >= 70) return 'conf high';
  if(c >= 50) return 'conf med';
  return 'conf low';
}

function safeNum(x, dp=2){
  return (typeof x === 'number' && isFinite(x)) ? x.toFixed(dp) : '—';
}

function getDailyChange(ticker, fallbackTodayClose){
  const arr = (window.SNAP.prices && window.SNAP.prices[ticker]) ? window.SNAP.prices[ticker] : null;
  if(!arr || arr.length < 2){
    const today = (typeof fallbackTodayClose === 'number') ? fallbackTodayClose : null;
    return { prevClose: null, todayClose: today, change: null, changePct: null };
  }
  const last = arr[arr.length - 1];
  const prev = arr[arr.length - 2];
  const todayClose = (typeof last.Close === 'number') ? last.Close : (typeof fallbackTodayClose === 'number' ? fallbackTodayClose : null);
  const prevClose = (typeof prev.Close === 'number') ? prev.Close : null;

  if(todayClose == null || prevClose == null || prevClose === 0){
    return { prevClose, todayClose, change: null, changePct: null };
  }

  const change = todayClose - prevClose;
  const changePct = (change / prevClose) * 100;
  return { prevClose, todayClose, change, changePct };
}

/**
 * Conservative 1D predicted close estimate:
 * - Uses range_1d high/low as the typical 1-day move bounds
 * - Direction comes from action (BUY/SELL/HOLD) with a conservative multiplier
 */
function predictedClose1D(todayClose, row){
  const r = row.range_1d;
  if(todayClose == null || !r || r.low==null || r.high==null) return null;

  const act = (row.action || '').toUpperCase();
  const hi = r.high; // positive
  const lo = r.low;  // negative

  let expectedPct = 0;

  // Conservative multipliers so this doesn't look overconfident
  if(act === 'BUY') expectedPct = hi * 0.60;
  else if(act === 'SELL') expectedPct = lo * 0.60;
  else {
    // HOLD = near 0, slight lean in direction of trend if available
    const mid = (hi + lo) / 2;
    if(row.trend === 1) expectedPct = Math.max(0, hi * 0.20);
    else if(row.trend === -1) expectedPct = Math.min(0, lo * 0.20);
    else expectedPct = mid * 0.10;
  }

  return todayClose * (1 + expectedPct);
}

function addSectionRow(tbody, label){
  const tr = document.createElement('tr');
  tr.className = 'section';
  tr.innerHTML = `<td colspan="12">${label}</td>`;
  tbody.appendChild(tr);
}

function render(){
  const region = document.getElementById('region').value;
  const category = document.getElementById('category').value;
  const action = document.getElementById('action').value;
  const q = document.getElementById('q').value.trim().toUpperCase();

  const rows = window.SNAP.rows.filter(r=>{
    if(region && r.region !== region) return false;
    if(category && r.category !== category) return false;
    if(action && r.action !== action) return false;
    if(q && !String(r.ticker||'').toUpperCase().includes(q)) return false;
    return true;
  });

  // Top 5 biggest expected 1W movers (within filtered view)
  const movers = rows
    .map(r => ({ ticker: r.ticker, mag: moveMag(r.range_1w) }))
    .filter(x => x.mag != null)
    .sort((a,b)=> b.mag - a.mag)
    .slice(0, 5);
  const moverSet = new Set(movers.map(m => m.ticker));

  // Compute daily change info so we can pin winners/losers
  const enriched = rows.map(r=>{
    const dc = getDailyChange(r.ticker, r.last_close);
    return { r, dc };
  });

  const winners = enriched
    .filter(x => typeof x.dc.changePct === 'number')
    .sort((a,b)=> b.dc.changePct - a.dc.changePct)
    .slice(0, 5);

  const losers = enriched
    .filter(x => typeof x.dc.changePct === 'number')
    .sort((a,b)=> a.dc.changePct - b.dc.changePct)
    .slice(0, 5);

  const pinnedSet = new Set([...winners, ...losers].map(x => x.r.ticker));

  // Remaining rows (not pinned), sorted by confidence desc (as before)
  const rest = enriched
    .filter(x => !pinnedSet.has(x.r.ticker))
    .sort((a,b)=> (b.r.confidence||0) - (a.r.confidence||0));

  const tb = document.getElementById('tbody');
  tb.innerHTML = '';

  // Render pinned winners
  if(winners.length){
    addSectionRow(tb, "Top 5 Winners (Today)");
    winners.forEach(x => renderRow(tb, x.r, x.dc, moverSet, true, false));
  }

  // Render pinned losers
  if(losers.length){
    addSectionRow(tb, "Top 5 Losers (Today)");
    losers.forEach(x => renderRow(tb, x.r, x.dc, moverSet, false, true));
  }

  // Render the rest
  addSectionRow(tb, "All Stocks");
  rest.forEach(x => renderRow(tb, x.r, x.dc, moverSet, false, false));
}

function renderRow(tb, r, dc, moverSet, isWinnerPin, isLoserPin){
  const tr = document.createElement('tr');

  const act = (r.action || '').toUpperCase();
  if(act === 'BUY') tr.classList.add('row-buy');
  else if(act === 'SELL') tr.classList.add('row-sell');
  else tr.classList.add('row-hold');

  if(moverSet.has(r.ticker)) tr.classList.add('big-mover');
  if(isWinnerPin) tr.classList.add('pin-winner');
  if(isLoserPin) tr.classList.add('pin-loser');

  const pillClass = act === 'BUY' ? 'pill buy' : act === 'SELL' ? 'pill sell' : 'pill hold';
  const pillText = act || '—';
  const pill = `<span class="${pillClass}">${pillText}</span>`;

  const conf = (typeof r.confidence === 'number') ? r.confidence : null;
  const confBadge = `<span class="${confClass(conf)}">${conf ?? '—'}</span>`;

  const changeClass = (typeof dc.change === 'number')
    ? (dc.change > 0 ? 'pos' : (dc.change < 0 ? 'neg' : ''))
    : '';
  const changeTxt = (typeof dc.change === 'number') ? `${dc.change > 0 ? '+' : ''}${dc.change.toFixed(2)}` : '—';
  const changePctTxt = (typeof dc.changePct === 'number') ? `${dc.changePct > 0 ? '+' : ''}${dc.changePct.toFixed(2)}%` : '—';

  const pred = predictedClose1D(dc.todayClose, r);
  const predTxt = (typeof pred === 'number') ? pred.toFixed(2) : '—';
  const predClass = (typeof pred === 'number' && typeof dc.todayClose === 'number')
    ? (pred > dc.todayClose ? 'pos' : (pred < dc.todayClose ? 'neg' : ''))
    : '';

  const notes = [];
  if(r.trend===1) notes.push('Uptrend (MA50>MA200)');
  if(r.trend===-1) notes.push('Downtrend (MA50<MA200)');
  if(r.mom_6m!=null && typeof r.mom_6m === 'number') {
    const v = (r.mom_6m*100);
    notes.push(`6M mom: <span class="${v>=0?'pos':'neg'}">${v.toFixed(1)}%</span>`);
  }
  if(r.vol_20d_ann!=null && typeof r.vol_20d_ann === 'number') notes.push(`Vol: ${(r.vol_20d_ann*100).toFixed(0)}%`);
  if(r.rsi14!=null && typeof r.rsi14 === 'number') notes.push(`RSI: ${r.rsi14.toFixed(0)}`);

  const firstNews = (window.SNAP.news && window.SNAP.news[r.ticker] || [])[0];
  const newsHtml = firstNews
    ? `<div class="news small">News: <a href="${firstNews.link}" target="_blank" rel="noreferrer">${firstNews.title}</a></div>`
    : '';

  const star = moverSet.has(r.ticker) ? `<span class="star" title="Top 5 expected 1W movers">⭐</span>` : '';

  tr.innerHTML = `
    <td>${star}<b>${r.ticker ?? '—'}</b>${newsHtml}</td>
    <td class="nowrap">${(r.region ? String(r.region).toUpperCase() : '—')}</td>
    <td>${r.category ?? '—'}</td>
    <td class="nowrap">${pill}</td>
    <td class="nowrap">${confBadge}</td>
    <td class="nowrap">${safeNum(dc.prevClose, 2)}</td>
    <td class="nowrap">${safeNum(dc.todayClose, 2)}</td>
    <td class="nowrap"><span class="${changeClass}">${changeTxt}</span></td>
    <td class="nowrap"><span class="${changeClass}">${changePctTxt}</span></td>
    <td class="nowrap"><span class="${predClass}">${predTxt}</span></td>
    <td class="small">
      1D: ${fmtPctRange(r.range_1d)}<br/>
      1W: ${fmtPctRange(r.range_1w)}<br/>
      1M: ${fmtPctRange(r.range_1m)}
    </td>
    <td class="small">${notes.join(' • ')}</td>
  `;
  tb.appendChild(tr);
}

load();
</script>
</body>
</html>
